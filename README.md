# Кастомная реализация HTTP-клиента и аутентификации

## В проекте реализован собственный HTTP-клиент и система аутентификации без использования стандартных библиотек вроде HttpClient или сторонних решений типа Axios. В основе лежит нативный HttpURLConnection из Java, интегрированный с Keycloak для управления пользователями, работы с токенами и контроля доступа на основе ролей.
Основные компоненты

  ### Кастомный HTTP-клиент (HttpHelper)

        Выполняет все типы HTTP-запросов (GET, POST, PUT) с поддержкой заголовков, параметров и тела запроса.

        Автоматически добавляет Bearer-токен в заголовки авторизации.

        Обрабатывает ответы сервера, включая ошибки (4xx/5xx), и парсит JSON-данные.

        Работает напрямую с HttpURLConnection, что даёт полный контроль над запросами без зависимостей от внешних библиотек.

  ### Интеграция с Keycloak (UserAuthHelper)

        Админский токен: Получает и кеширует токен при старте приложения (@PostConstruct) для выполнения привилегированных операций (регистрация пользователей, назначение ролей).

        Регистрация пользователей: Проверяет уникальность email и username, создаёт учетные записи в Keycloak и назначает роль USER.

        Работа с токенами:

            Аутентификация по логину/паролю (/token).

            Обновление токенов (/refresh_token).

            Выход из системы (/logout).

        Контроль доступа (RBAC):

            Проверяет права администратора через роли ADMIN (на уровне realm и клиента).

            Запрещает обычным пользователям изменять чужие данные.

        Парсинг JWT: Извлекает user_id из токена с помощью SignedJWT без использования Keycloak-адаптеров.

  ### REST API (UserAuthController)

        Доступные эндпоинты:

            Регистрация (/api/register).

            Вход (/api/login) и обновление токена (/api/refresh_token).

            Обновление данных (для пользователей /api/update_current_user_data, для админов /api/admin/update_user_data).

            Выход (/api/logout) и получение информации о пользователях (/api/users/{user_id}, /api/admin/users).

  ### Проверки:

            Пользователи могут редактировать только свои данные.

            Админские методы требуют роли ADMIN.

## Особенности реализации

    Отказ от стандартных HTTP-библиотек: Полный контроль над запросами через HttpURLConnection.

    Работа с токенами: Автоматическое обновление истекающих токенов, обработка событий истечения срока действия.

    Потокобезопасность: Синхронизация критических участков (например, инициализация админского токена).

    Логирование: Запись событий аутентификации и управления пользователями для аудита.

    Единая обработка ошибок: Кастомные исключения (CustomAppException) с понятными сообщениями и HTTP-статусами.

## Примеры сценариев

  ### Регистрация:

        POST /api/register → Проверка данных → Создание пользователя в Keycloak → Назначение роли USER → Возврат user_id.

  ### Вход в систему:

        POST /api/login → Аутентификация в Keycloak → Получение access_token и refresh_token.

  ### Обновление токена:

        POST /api/refresh_token → Получение новых токенов по refresh_token.

  ### Обновление данных админом:

        PUT /api/admin/update_user_data → Проверка прав → Изменение данных пользователя в Keycloak.

## Безопасность

    Валидация токенов: JWT парсятся локально, без доверия к клиентским данным.

    Защита данных: Пароли и токены не логируются, все запросы идут через HTTPS.

    Защита от перебора: Рекомендуется ограничение запросов на уровне nginx/API-гейтвея.
